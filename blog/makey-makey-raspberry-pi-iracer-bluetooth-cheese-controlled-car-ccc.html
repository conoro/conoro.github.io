<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>MaKey MaKey + Raspberry Pi + iRacer + Bluetooth = Cheese Controlled Car (CCC) | Cross Dominant</title><meta name="description" content="Mixed Laterality since 1968"><meta property="og:title" content="MaKey MaKey + Raspberry Pi + iRacer + Bluetooth = Cheese Controlled Car (CCC) | Cross Dominant"><meta property="og:type" content="article"><meta property="og:description" content="Mixed Laterality since 1968"><meta property="og:url" content="http://conoro.github.io/blog/makey-makey-raspberry-pi-iracer-bluetooth-cheese-controlled-car-ccc"><meta property="og:image" content="http://conoro.github.io/images/logo.png"><meta property="og:site_name" content="Cross Dominant"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@conoro"><meta name="twitter:creator" content="@conoro"><meta name="twitter:title" content="MaKey MaKey + Raspberry Pi + iRacer + Bluetooth = Cheese Controlled Car (CCC) | Cross Dominant"><meta name="twitter:description" content="Mixed Laterality since 1968"><meta name="twitter:image" content="http://conoro.github.io/images/logo.png"><link rel="author" href="https://plus.google.com/+ConorONeill/posts"><link rel="shortcut icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" title="Cross DominantRSS Feed" href="/blog/rss.xml"><link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic"><link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lekton"><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script src="/js/html5shiv.js"></script><![endif]--><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-88610-4']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></head><body class="page-blog blog-makey-makey-raspberry-pi-iracer-bluetooth-cheese-controlled-car-ccc"><header class="masthead"><div class="container"><h1><a href="/">Cross Dominant</a></h1></div><div class="img"></div></header><div class="content"><div class="container"><article class="post"><h1 class="lg title">MaKey MaKey + Raspberry Pi + iRacer + Bluetooth = Cheese Controlled Car (CCC)</h1><h2 class="sm date">1356806716000</h2><h1>&quot;MaKey MaKey + Raspberry Pi + iRacer + Bluetooth = Cheese Controlled Car (CCC)&quot;</h1>
<p>When Santa told me that he was getting an <a href="http://www.coolcomponents.co.uk/catalog/racer-p-993.html">i-Racer</a> remote controlled car for Fionn, I was very excited. This is a remote controlled car that, on the surface looks very crude. Heck it doesn&#39;t even come with a remote control.</p>
<p><a href="http://www.coolcomponents.co.uk/catalog/racer-p-993.html"><img class="size-medium wp-image-914 aligncenter" title="iracer" src="http://conoroneill.net/wp-content/uploads/2012/12/iracer-300x300.jpg" alt="" width="300" height="300" /></a></p>
<p>That&#39;s because it&#39;s Bluetooth-controlled! You can install a simple Android App, pair with the car and control it either with on-screen controls or using the accelerometer in the phone.</p>
<p>As a standalone present it is pretty neat but like all remote controlled toys, I&#39;m sure would be discarded after a few days use. However Santa didn&#39;t want to spend a fortune on a full-blown Arduino-based robot platform or an even bigger fortune on Lego Mindstorms.</p>
<p>It&#39;s when you start thinking about what is possible over time with the i-Racer that things get really interesting. Forgetting electronics for a minute, you could have huge fun making new shells for it out of different materials. Imagine a Foldify template for it so you could make printed paper shells. Lego might be a bit heavy but K&#39;Nex plus some Sugru could work very nicely. Or what about bamboo food skewers or ice-pop sticks? Maybe just some stickers.</p>
<p><a href="http://conoroneill.net/wp-content/uploads/2012/12/IMG_20121229_141040.jpg"><img class="size-large wp-image-919 alignnone" title="IMG_20121229_141040" src="http://conoroneill.net/wp-content/uploads/2012/12/IMG_20121229_141040-1024x768.jpg" alt="" width="584" height="438" /></a></p>
<p>Then there is the code running on the car. The source is available so you can play around with it. Now this isn&#39;t the easiest thing in the world to do since the car is not Arduino so you need compilers and special programming dongles, but the option is there.</p>
<p>Taking that one step further, you could clip on other bits of electronics. I have a temp sensor, a PIR detector and an Ultrasonic distance detector all winging their way from China. You could use these to give the car a lot more &quot;intelligence&quot;. There is also someone working on porting the car&#39;s code to Arduino since the microcontroller is compatible.</p>
<p>But that stuff is hard and more long term and wouldn&#39;t actually involved Fionn doing much. Always have to keep your focus on the &quot;customer&quot;! So I thought about it some more and realised that you could have enormous fun with how you control the car. The use of Bluetooth gives you a giant range of pretty <em>cough</em> easy possibilities.</p>
<p>So I started playing with some Python code and after a ton of dead-ends, Linux bugs and system problems I was finally able to talk to the car from my Ubuntu PC with a $2 Bluetooth dongle. (Details below)</p>
<p>Then I realised that this would be no use over Christmas as we spend it travelling to family houses around the country without the Ubuntu PC. My Windows laptop should work with tweaks but that&#39;s not for games! So I started looking at the Raspberry Pi. Whatever problems I had run into on my PC were 10x worse on the Pi. (More details below)</p>
<p>After a ton of messing I got keyboard control working the way I wanted over USB on the RPi. Which leads to the piece de resistance - <a href="http://www.makeymakey.com/">MaKey MaKey</a> control. MaKey MaKey is a beautifully simple idea. It&#39;s an Arduino-compatible board you plug into a PC and it emulates various key-presses and mouse clicks. You then connect whatever you want, as long as it is vaguely conductive, and use that for input. It famously uses bananas, pencil drawings and buckets of water as inputs to various fun software.</p>
<h2>The Cheese Controlled Car (CCC)</h2>
So Fionn finally had the ultimate car controller. 5 Pieces of Christmas Cheese connected to a Raspberry Pi via MaKey MaKey talking to a car over Bluetooth. Check it out in action:

httpv://www.youtube.com/watch?v=qb9wso0pB4o

If you want to try this yourself and run into any problems, pop a comment in below.

Otherpossibilitiesinclude grapes (GCC):
<a href="http://conoroneill.net/wp-content/uploads/2012/12/grapes.jpg"><img class="alignnone size-large wp-image-918" title="grapes" src="http://conoroneill.net/wp-content/uploads/2012/12/grapes-1024x509.jpg" alt="" width="584" height="290" /></a>

And Barbie (BCC):
<a href="http://conoroneill.net/wp-content/uploads/2012/12/IMG_20121229_141006.jpg"><img class="alignnone size-large wp-image-917" title="IMG_20121229_141006" src="http://conoroneill.net/wp-content/uploads/2012/12/IMG_20121229_141006-768x1024.jpg" alt="" width="584" height="778" /></a>

Now for the nasty details. Whilst these steps are quite short and the code is very simple, it took a week of evenings cursing, hacking and googling to get everything working right.
<div></div>
<h2>Technical Nitty Gritty</h2>

<p><strong>UPDATE 1</strong>: Much improved code compared to the simple one below <a href="https://github.com/conoro/iracer-controllers">is now available on GitHub</a>.</p>
<p>The main steps in getting the code to run were as follows:</p>
<p><ol>
    <li>Figure out Bluetooth on Linux using<a href="http://people.csail.mit.edu/albert/bluez-intro/x232.html">Bluez</a></li>
    <li>Figure out how to connect to car over Bluetooth using Python with<a href="http://code.google.com/p/pybluez/wiki/Documentation">PyBluez</a></li>
    <li>Sort out bad bug in Bluetooth on Debian (and therefore Ubuntu)</li>
    <li>Realise that most cheap micro Bluetooth dongles from China have duplicate MAC addresses and cannot talk to each other.</li>
    <li>Discover that Bluetooth dongle works on USB hub on Raspberry Pi at low-level but Bluetooth stack cannot see it. So connect it to one of USB ports on Raspberry Pi</li>
    <li>Discover that cheap Chinese Bluetooth dongles hang the Raspberry Pi after random amount of time</li>
    <li>Switch to using older bigger more expensive Bluetooth dongle</li>
    <li>Realise that Bluetooth dongle must be plugged in after booting Raspberry Pi in order for it to be detected</li>
    <li><em>Repeatedly curse the totally messed up implementation of USB on the Raspberry Pi</em></li>
    <li>Use a powered USB Hub to connect the MaKey MaKey and anything else like WiFi to the Raspberry Pi</li>
    <li>Figure out basic keyboard reading in Python</li>
    <li>Figure out reading keyboard in Python without carriage-return</li>
    <li>Try PyGame for keyboard reading but discover it needs a screen attached</li>
    <li>Figure out reading directly from USB with auto-repeat using<a href="http://gvalkov.github.com/python-evdev/">Evdev</a>and<a href="https://github.com/gvalkov/python-evdev">python-evdev</a>(must be run as sudo)</li>
</ol></p>
<p><h2>Installs and Tweaks</h2>
[bash]
sudo apt-get update
sudo apt-get upgrade
sudo apt-get install python-pip python-dev build-essential
sudo apt-get install --no-install-recommends bluetooth 
sudo apt-get install bluez python-bluez bluez-hcidump
sudo pip install evdev
[/bash]</p>
<p>Now you need to work around a nasty bug in Debian and Ubuntu. They have accidentally compiled in code for Nokia Series 60!</p>
<p>[bash]
sudo nano /etc/bluetooth/main.conf
[/bash]</p>
<p>add this line to it:</p>
<p>[code]
DisablePlugins = pnat
[/code]</p>
<p>Now plug in the Bluetooth dongle, power up the i-racer and run:</p>
<p>[bash]
hcitool dev
[/bash]</p>
<p>It should detect your dongle and report its MAC address. If it does, then run:</p>
<p>[bash]
hcitool scan
[/bash]</p>
<p>This should find the i-racer as a Dagu Car. Note its MAC address and then pair to it by running:</p>
<p>[bash]
bluez-simple-agent hci0 00:12:05:09:94:26
[/bash]</p>
<p>where you replace 00:12:05:09:94:26 with the MAC address of your car. The PIN is either 1234 or 0000</p>
<p>In a Python shell, (sudo python) run the following to find out your Keyboard or MakeyMakey ID:</p>
<p>[python]
from evdev import InputDevice, list_devices
devices = map(InputDevice, list_devices())
for dev in devices:
    print( &#39;%-20s %-32s %s&#39; % (dev.fn, dev.name, dev.phys) )
[/python]</p>
<p>My MaKey MaKey comes up (with KB/Mouse/Joystick disconnected) as:</p>
<p>[code]
/dev/input/event0 Unknown USB IO Board usb-bcm2708_usb-1.3.3/input2
[/code]</p>
<p><h2>The Code</h2>
Finally run this code as sudo to control the car using the MaKey MaKey:</p>
<p>[python]
import sys
import select
import tty
import termios
import bluetooth
import time
from evdev import InputDevice, categorize, ecodes</p>
<p>if <strong>name</strong> == &#39;<strong>main</strong>&#39;:</p>
<pre><code>dev = InputDevice(&#39;/dev/input/event0&#39;)

bd_addr = &amp;quot;00:12:05:09:94:26&amp;quot;
port = 1
sock = bluetooth.BluetoothSocket( bluetooth.RFCOMM )
sock.connect((bd_addr, port))

for event in dev.read_loop():
    if event.type == ecodes.EV_KEY:
        key_pressed = str(categorize(event))
        if &#39;KEY_LEFT&#39; in key_pressed:
            # 0x5X for left forward. 0x51 very slow. 0x5F fastest
            sock.send(&#39;\x5A&#39;)
        if &#39;KEY_RIGHT&#39; in key_pressed:
            # 0x6X for right forward. 0x11 very slow. 0x1F fastest
            sock.send(&#39;\x6A&#39;)
        if &#39;KEY_DOWN&#39; in key_pressed:
            # 0x2X for straight backward. 0x21 very slow. 0x2F fastest
            sock.send(&#39;\x2A&#39;)
        if &#39;KEY_UP&#39; in key_pressed:
            # 0x1X for straight forward. 0x11 very slow. 0x1F fastest
            sock.send(&#39;\x1A&#39;)
        if &#39;KEY_SPACE&#39; in key_pressed:
            #stop
            sock.send(&#39;\x00&#39;)</code></pre>
<p>[/python]</p>
<p>Note that this is extremely simple control with fixed speed just to prove the idea works. Real code will go up on GitHub when it has much more usable controls with automatic acceleration/deceleration etc and after I make it configurable with any i-Racer and with the MaKey MaKey on any USB port.</p>
<p><h2>What&#39;s next?</h2>
Apart from extra sensors and new outer shells, I want to do more playing with controllers. I have an Arduino Joystick shield, Arduino Nano and serial Bluetooth breakout board coming from China. It&#39;d be cool to make some sort of interesting custom controller case with the Arudino controlling the car. I may also get an <a href="http://arduino.cc/en/Main/ArduinoBoardEsplora">Arduino Esplora</a>.</p>
<p>The other really obvious one is to stick with the RPi and pair a Wiimote to it too. That could be the ultimate controller for the car.</p>
<p>One downside of the i-Racer is that <a href="http://www.arexx.com.cn/ch/ProductShow.asp?ID=120">Arexx</a>, the Chinese manufacturers, have not released the source-code to their Android App, only to the car software itself. Given how trivially simple the control protocol is, it should be very easy for someone to create Open Source equivalents for Android and iOS or even WP8 or BB10. I&#39;m currently poking around inside PhoneGap&#39;s Bluetooth support (<a href="https://github.com/huseyinkozan/phonegap-bluetooth/blob/master/README_EN.md">this plugin</a>) to see if a simple cross-platform Mobile Hybrid App could be created.</p>
<p>If this is a success, with success being defined as Fionn remaining interested, then I&#39;ll bite the bullet and start getting the parts for one of the good Arduino robot kits out there. A good intermediate step might be the <a href="https://www.sparkfun.com/products/11012">Sparkfun Protosnap Minibot Kit</a>. After that, the sky is the limit:</p>
<p><a href="http://conoroneill.net/wp-content/uploads/2012/12/Moon2_1434681c_1746903c.jpg"><img class="alignnone size-full wp-image-921" title="Moon2_1434681c_1746903c" src="http://conoroneill.net/wp-content/uploads/2012/12/Moon2_1434681c_1746903c.jpg" alt="" width="460" height="288" /></a></p>
<aside class="center author"><img src="/images/CliveStrong.jpg" alt="Conor O'Neill"/><h2 class="sm">Conor O'Neill</h2><p>Is an Irish technology guy. One of Ireland's first bloggers.</p><p class="links"><a href="/authors/admin">Posts</a><span>•</span><a href="http://twitter.com/conoro">Twitter</a><span>•</span><a href="https://plus.google.com/+ConorONeill/posts">Google+</a><span>•</span><a href="https://github.com/conoro">GitHub</a></p></aside><section class="comments"><h2>Discuss</h2><div id="disqus_thread"><script>var disqus_shortname = 'conor';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></section><nav class="post-nav"><ul class="clearfix"><li><a href="scriptcraft-a-minecraft-mod-that-lets-you-build-using-javascript" title="ScriptCraft - A Minecraft mod that lets you build using Javascript" class="post-prev"><strong>Previous Post</strong><span>ScriptCraft - A Minecraft mod that lets you build using Javascript</span></a></li><li><a href="the-cult-of-done-manifesto" title="The Cult of Done Manifesto" class="post-next"><strong>Next Post</strong><span>The Cult of Done Manifesto</span></a></li></ul></nav></article></div></div></body></html>