<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Interfacing Node.js to Raspberry Pi hardware like 433Mhz transmitters with node-ffi | Cross Dominant</title><meta name="description" content="Now that I can control the Efergy RC mains sockets easily with a DigiX Arduino, it's time to make the same thing work on Node.js running on a Raspberry Pi. Turns out it's not quite so easy!"><meta property="og:title" content="Interfacing Node.js to Raspberry Pi hardware like 433Mhz transmitters with node-ffi | Cross Dominant"><meta property="og:type" content="article"><meta property="og:description" content="Now that I can control the Efergy RC mains sockets easily with a DigiX Arduino, it's time to make the same thing work on Node.js running on a Raspberry Pi. Turns out it's not quite so easy!"><meta property="og:url" content="http://conoroneill.net//undefined"><meta property="og:image" content="http://conoroneill.net//images/logo.png"><meta property="og:site_name" content="Cross Dominant"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@conoro"><link rel="shortcut icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" title="Cross DominantRSS Feed" href="/feed/"><link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lato:400,300,300italic,400italic,700,700italic"><link rel="stylesheet" href="/css/prism.css"><link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lekton"><link rel="stylesheet" href="/css/main.css"><script src="/js/prism.js"></script><!--[if lt IE 9]><script src="/js/html5shiv.js"></script><![endif]--><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-88610-4']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></head><body class="page-interfacing-nodejs-to-raspberry-pi-hardware-with-node-ffi interfacing-nodejs-to-raspberry-pi-hardware-with-node-ffi"><header class="masthead"><div class="container"><h1><a href="/">Cross Dominant</a></h1></div><div class="search-box"><script type="text/javascript">(function() {
  var cx = '001461447920948202874:5htheqgvd1w';
  var gcse = document.createElement('script');
  gcse.type = 'text/javascript';
  gcse.async = true;
  gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//www.google.com/cse/cse.js?cx=' + cx;
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(gcse, s);
})();</script><gcse:search></gcse:search></div></header><div class="content"><div class="container"><article class="post"><h1 class="lg title">Interfacing Node.js to Raspberry Pi hardware like 433Mhz transmitters with node-ffi</h1><h2 class="sm date">30 Mar 2014</h2><p>Now that I can talk to the Efergy remote control switches using Arduino and <a href="http://digistump.com/products/50">DigiX</a>, it&#39;s time to do the same thing with Raspberry Pi and Node.js.</p>
<p>But first, check out this gorgeous <a href="http://shop.pimoroni.com/products/pibow-timber">Pimoroni Pibow Timber</a> case that the RPi now lives in. Makes me smile every time I look at it.</p>
<p><img src="https://s3-eu-west-1.amazonaws.com/conoroneill.net/wp-content/uploads/2014/03/pibow_timber.jpg" alt="Pibow" title="Pibow Timber Raspberry Pi case"></p>
<p>Start by plugging in one of the Efergy switches and using its remote control to set its code. Use the sniffer program from <a href="http://conoroneill.net/our-web-and-mobile-enabled-electric-blanket-using-electric-irelands-efergy-rc-sockets">the last post</a> to find out what that code is.</p>
<p>Connecting the 433MHz transmitter to the RPi is dead easy. Connect GND to pin 6, VCC to PIN 1 and DATA to PIN 11. More details on the <a href="https://projects.drogon.net/raspberry-pi/wiringpi/pins/">WiringPi Pinout</a>. For our purposes: BCM GPIO 17 == WiringPi 0 == Pin 11 == GPIO #0</p>
<p>The simplest way of doing this is to create a command-line program in C or C++ and then shell out to it in Node. But where&#39;s the fun in that? The core approach I decided to use was via a Node module called <a href="https://github.com/rbranson/node-ffi/wiki/Node-FFI-Tutorial">Node FFI</a> which makes it relatively easy to call out to C libraries from Node. The alternative is to build a Node module in C++. But that wasn&#39;t going to work, given that I haven&#39;t written a line of C++ in my life, after the trauma of doing a training course in it in the late 90s and seeing the horror inflicted on my beloved C.</p>
<p>Unfortunately I quickly realised that node-ffi only does C whilst the <a href="https://github.com/r10r/rcswitch-pi/">RCSWitch-Pi</a> library is C++ (but the <a href="https://projects.drogon.net/raspberry-pi/wiringpi/functions/">WiringPi library</a> under that is C again!). </p>
<p>An abortive attempt at using <a href="https://github.com/tjfontaine/node-ffi-generate">ffi-generate</a> went nowhere as it wouldn&#39;t even run on the RPi due to some libclang problem. Running in an Ubuntu VM worked after a lot of llvm messing but I couldn&#39;t make any sense of the output.</p>
<p>Cue a lonnnngggg session Googling how to interface C to C++ and realising that I hate C++ even more now :-) Eventually I found an <a href="http://www.teddy.ch/c++_library_in_c/">idiot&#39;s guide to wrapping C++</a> so it can be called by C. Bit by bit I figured it all out but hit a brick wall at one point. This forced me to use the GDB debugger for the first time in 15 years. Luckily I spotted the problem using GDB in about a minute flat and got a test C program working which would call the C++ functions correctly. </p>
<p>Then it was back to Node.js and node-ffi for another round of head scratching and non-stop errors. Finally it all clicked and the Efergy module clicked too!</p>
<p>Now that I have the basics working, I will clean up this code and use it in the Node server that will run on the RPi via the usual exports/require approach. I&#39;ll also hopefully be able to apply the same approach to any C++ or C library that accesses any RPi hardware.</p>
<p>The final set of steps are actually quite simple. All the effort was in the learning.</p>
<h3>Install WiringPi</h3>
<pre><code class="language-bash">
mkdir ~/gitwork
cd gitwork
git clone git://git.drogon.net/wiringPi
cd wiringPi
./build

### Install RCSwitch-Pi
cd ~/gitwork
git clone https://github.com/r10r/rcswitch-pi.git
cd rcswitch-pi
make
</code></pre>

<h3>Build an RCSwitch-Pi library</h3>
<pre><code class="language-bash">
gcc -shared -fpic RCSwitch.cpp -o libRCSwitch.so
</code></pre>

<h3>Simple C++ test to make sure you can talk to Efergy</h3>
<pre><code class="language-bash">
cd ~/gitwork/rcswitch-pi
nano efergy.cpp
</code></pre>

<p>Paste this in</p>
<pre><code class="language-c">
#include "RCSwitch.h"
#include <stdlib.h>
#include <stdio.h>

int main(int argc, char *argv[]) {

    /*
     output PIN is hardcoded for testing purposes
     see https://projects.drogon.net/raspberry-pi/wiringpi/pins/
     for pin mapping of the raspberry pi GPIO connector
     */
    int PIN = 0;
    int unitCode = atoi(argv[1]);

    if (wiringPiSetup () == -1) return 1;
        printf("sending unitCode[%i]\n", unitCode);
        RCSwitch mySwitch = RCSwitch();
        mySwitch.enableTransmit(PIN);

        mySwitch.send(unitCode,24);

        return 0;
}
</code></pre>

<p>Save it. Now compile and run it:</p>
<pre><code class="language-bash">
g++ -c -o efergy.o efergy.cpp
g++ RCSwitch.o efergy.o -o efergy -lwiringPi
sudo ./efergy 109011
sudo ./efergy 109019
</code></pre>

<p>If all is working ok, the switch will turn on and off.</p>
<h3>Install Node/NPM on Raspberry Pi</h3>
<pre><code class="language-bash">
cd ~
sudo mkdir /opt/node
wget http://nodejs.org/dist/v0.10.23/node-v0.10.23-linux-arm-pi.tar.gz
tar xvzf node-v0.10.23-linux-arm-pi.tar.gz
sudo cp -r node-v0.10.2-linux-arm-pi/* /opt/node
cd ~
nano .bash_profile

#Add these lines to the file you opened
PATH=$PATH:/opt/node/bin
export PATH

#Save and exit

#Test
node -v
npm -v
</code></pre>


<h3>Wrapping C++ so it can be called by C</h3>
<p>Create wrapper.h and wrapper.c</p>
<p>wrapper.h:</p>
<pre><code class="language-c">
#ifndef __MYWRAPPER_H
#define __MYWRAPPER_H

#ifdef __cplusplus
extern "C" {
#endif

  typedef struct RCSwitch RCSwitch;

  RCSwitch* newRCSwitch();

  void RCSwitch_send(RCSwitch* v, unsigned long Code, unsigned int length);

  void RCSwitch_enableTransmit(RCSwitch* v, int nTransmitterPin);

  void deleteRCSwitch(RCSwitch* v);

#ifdef __cplusplus
}
#endif
#endif
</code></pre>

<p>wrapper.c:</p>
<pre><code class="language-c">
#include "RCSwitch.h"
#include "wrapper.h"
#include <stdio.h>

extern "C" {
  RCSwitch* newRCSwitch() {
    //printf("Inside newRCSwitch");
    return new RCSwitch();
  }

  void RCSwitch_send(RCSwitch* v, unsigned long Code, unsigned int length) {
    //printf("Inside RCSwitch_send");
    v->send(Code, length);
  }

  void RCSwitch_enableTransmit(RCSwitch* v, int nTransmitterPin) {
    //printf("Inside RCSwitch_enableTransmit");
    v->enableTransmit(nTransmitterPin);
  }

  void deleteRCSwitch(RCSwitch* v) {
    delete v;
  }
}
</code></pre>

<h3>Compile everything</h3>
<p>Use -g flag everywhere if you want to debug with GDB (gdb efergy2, break main, run 109011, next, next). Simple <a href="http://web.eecs.umich.edu/~sugih/pointers/summary.html">GDB Tutorial here</a> and some tips on <a href="http://www.raspberrypi.org/forum/viewtopic.php?f=33&amp;t=15312">RPi Forums</a>.</p>
<pre><code class="language-bash">
g++ -g -c wrapper.c -o wrapper.o
gcc -g -c efergy.c -o efergy.o
g++ -shared -fpic -g RCSwitch.cpp -L ./ -l wiringPi -o libRCSwitch.so
g++ -g efergy.o wrapper.o ./libRCSwitch.so -o efergy2
</code></pre>

<h3>Run the C program</h3>
<pre><code class="language-bash">
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:./
sudo ./efergy2 109011
</code></pre>

<p>Now to get everything running in Node/JavaScript</p>
<h3>Install Node FFI</h3>
<pre><code class="language-bash">
sudo npm install -g ffi
</code></pre>

<h3>Create send.js</h3>
<pre><code class="language-javascript">
var ffi = require("ffi")

var libwiringPi = ffi.Library('/usr/local/lib/libwiringPi', {
    'wiringPiSetup' : [ 'int', [] ],
    'digitalWrite' : [ 'void', ['int', 'int'] ],
    'pinMode': [ 'void', ['int', 'int'] ],
    'delayMicroseconds' :  [ 'void', ['int', 'int'] ]
})

var libRCSwitch = ffi.Library('./libwrapper', {
  'newRCSwitch' : ['pointer', [] ],
  'RCSwitch_send': ['void', [ 'pointer', 'int', 'int' ] ],
  'RCSwitch_enableTransmit': ['void', ['pointer', 'int'] ]
})

if (process.argv.length < 3) {
  console.log('Arguments: Efergy Switch Code')
  process.exit()
}

var PIN = 0;
var unitCode = parseInt(process.argv[2]);
var mySwitch = libRCSwitch.newRCSwitch();

if (libwiringPi.wiringPiSetup() == -1){
    return 1;
    printf("Error initialising WiringPi");
}

if (mySwitch.isNull()) {
    console.log("Oh no! Couldn't create object!\n");
} else {
    libRCSwitch.RCSwitch_enableTransmit(mySwitch, PIN);
    libRCSwitch.RCSwitch_send(mySwitch, unitCode, 24);
}
</code></pre>


<h3>Compile the libraries</h3>
<pre><code class="language-bash">
g++ -shared -fpic -g wrapper.c -L ./ -l RCSwitch -o libwrapper.so
g++ -shared -fpic -g RCSwitch.cpp -L ./ -l wiringPi -o libRCSwitch.so
</code></pre>

<h3>Run send.js</h3>
<p>Note that anything which uses WiringPi has to be run sudo. A bit of a pain. Not sure I want to be running the Node process as root?</p>
<pre><code class="language-bash">
sudo env PATH=$PATH LD_LIBRARY_PATH=$LD_LIBRARY_PATH:./ node send.js 109011
</code></pre>

<p>That&#39;s it. You can now turn on and off your Efergy socket using Node. Next up, a simple Node server to handle remote requests to do this.</p>
<section class="comments"><h2>Discuss</h2><div id="disqus_thread"><script>var disqus_shortname = 'crossdominant';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></section><nav class="post-nav"><ul class="clearfix"><li><a href="our-web-and-mobile-enabled-electric-blanket-using-electric-irelands-efergy-rc-sockets" title="Our web and mobile enabled electric blanket using Electric Ireland's Efergy RC sockets" class="post-prev"><strong>Previous Post</strong><span>Our web and mobile enabled electric blanket using Electric Ireland's Efergy RC sockets</span></a></li></ul></nav></article></div></div></body></html>